<!-- blog/templates/blog/bookmark_list.html -->
{% extends "base.html" %}
{% load static %}

{% block title %}我的收藏 - {{ site_settings.site_name }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <!-- 页面标题 -->
        <div class="card mb-4 shadow-sm">
            <div class="card-body text-center">
                <h1 class="display-5 fw-bold mb-3">
                    <i class="bi bi-bookmark-heart me-2"></i>
                    我的收藏夹
                </h1>

                <div class="lead mb-4">
                    这里收藏着您感兴趣的文章，方便随时查看
                </div>

                <!-- 收藏统计 -->
                <div class="d-flex justify-content-center gap-4 mt-4">
                    <div class="text-center">
                        <div class="fs-3 fw-bold">{{ bookmarks.paginator.count }}</div>
                        <div class="text-muted">篇文章</div>
                    </div>
                    <div class="text-center">
                        <div class="fs-3 fw-bold">
                            {{ total_authors }}
                        </div>
                        <div class="text-muted">位作者</div>
                    </div>
                    <div class="text-center">
                        <div class="fs-3 fw-bold">
                            {{ categories_count }}
                        </div>
                        <div class="text-muted">个分类</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 收藏操作 -->
        <div class="card mb-4 shadow-sm">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <a href="{% url 'blog:home' %}" class="btn btn-primary">
                            <i class="bi bi-search"></i> 发现更多文章
                        </a>
                        <button class="btn btn-outline-secondary" id="toggle-bookmark-selection">
                            <i class="bi bi-check2-square"></i> 批量操作
                        </button>
                    </div>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="bi bi-filter"></i> 筛选排序
                        </button>
                        <ul class="dropdown-menu">
                            <li>
                                <a class="dropdown-item" href="?sort=-created">
                                    <i class="bi bi-sort-down"></i> 最近收藏
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="?sort=created">
                                    <i class="bi bi-sort-up"></i> 最早收藏
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="?sort=-article__view_count">
                                    <i class="bi bi-eye"></i> 按阅读量
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="?sort=-article__like_count">
                                    <i class="bi bi-heart"></i> 按点赞数
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <h6 class="dropdown-header">按分类</h6>
                                {% for cat in categories %}
                                <a class="dropdown-item" href="?category={{ cat.slug }}">
                                    {{ cat.name }} ({{ cat.count }})
                                </a>
                                {% endfor %}
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- 收藏列表 -->
        {% if bookmarks %}
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 mb-4">
            {% for bookmark in bookmarks %}
            <div class="col">
                <div class="card h-100 shadow-sm bookmark-card">
                    <!-- 文章图片 -->
                    {% if bookmark.article.featured_image %}
                    <img src="{{ bookmark.article.featured_image.url }}"
                         class="card-img-top"
                         alt="{{ bookmark.article.title }}"
                         style="height: 180px; object-fit: cover;">
                    {% else %}
                    <div class="card-img-top bg-secondary d-flex align-items-center justify-content-center"
                         style="height: 180px;">
                        <i class="bi bi-journal-text text-white display-4"></i>
                    </div>
                    {% endif %}

                    <!-- 收藏时间标签 -->
                    <div class="position-absolute top-0 end-0 m-2">
                        <span class="badge bg-info">
                            <i class="bi bi-clock"></i> {{ bookmark.created_at|date:"m-d" }}
                        </span>
                    </div>

                    <div class="card-body d-flex flex-column">
                        <!-- 分类标签 -->
                        {% if bookmark.article.category %}
                        <a href="{% url 'blog:category' bookmark.article.category.slug %}"
                           class="badge bg-primary align-self-start text-decoration-none mb-2">
                            {{ bookmark.article.category.name }}
                        </a>
                        {% endif %}

                        <!-- 标题 -->
                        <h5 class="card-title">
                            <a href="{{ bookmark.article.get_absolute_url }}"
                               class="text-decoration-none text-dark">
                                {{ bookmark.article.title|truncatechars:50 }}
                            </a>
                        </h5>

                        <!-- 作者信息 -->
                        <div class="d-flex align-items-center mb-3">
                            {% if bookmark.article.author.profile_picture %}
                            <img src="{{ bookmark.article.author.profile_picture.url }}"
                                 class="rounded-circle me-2"
                                 width="24"
                                 height="24"
                                 alt="{{ bookmark.article.author.username }}">
                            {% else %}
                            <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center me-2"
                                 style="width:24px;height:24px;">
                                <i class="bi bi-person text-white small"></i>
                            </div>
                            {% endif %}
                            <span class="small">{{ bookmark.article.author.username }}</span>
                            <span class="text-muted small ms-2">{{ bookmark.article.created_at|date:"Y-m-d" }}</span>
                        </div>

                        <!-- 摘要 -->
                        <p class="card-text flex-grow-1 small text-muted">
                            {{ bookmark.article.excerpt|default:bookmark.article.content|striptags|truncatechars:100 }}
                        </p>

                        <!-- 统计信息 -->
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <div class="d-flex gap-3 small text-muted">
                                <span>
                                    <i class="bi bi-eye"></i> {{ bookmark.article.view_count }}
                                </span>
                                <span>
                                    <i class="bi bi-heart"></i> {{ bookmark.article.like_count }}
                                </span>
                                <span>
                                    <i class="bi bi-chat-left"></i> {{ bookmark.article.comment_count }}
                                </span>
                            </div>
                        </div>

                        <!-- 操作按钮 -->
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <a href="{{ bookmark.article.get_absolute_url }}"
                               class="btn btn-outline-primary btn-sm">
                                阅读全文 <i class="bi bi-arrow-right"></i>
                            </a>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle"
                                        type="button"
                                        data-bs-toggle="dropdown">
                                    <i class="bi bi-three-dots"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li>
                                        <a class="dropdown-item"
                                           href="#"
                                           onclick="removeBookmark({{ bookmark.id }})">
                                            <i class="bi bi-bookmark-x text-danger me-2"></i> 取消收藏
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item"
                                           href="#"
                                           onclick="shareArticle('{{ bookmark.article.title }}', '{{ bookmark.article.get_absolute_url }}')">
                                            <i class="bi bi-share me-2"></i> 分享文章
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item"
                                           href="{% url 'accounts:profile' bookmark.article.author.username %}">
                                            <i class="bi bi-person me-2"></i> 查看作者
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- 复选框（批量操作时显示） -->
                    <div class="card-footer bg-transparent border-0">
                        <input type="checkbox"
                               class="form-check-input bookmark-checkbox"
                               data-bookmark-id="{{ bookmark.id }}"
                               style="display: none;">
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- 批量操作栏 -->
        <div class="card shadow-sm mb-4" id="bulk-bookmark-actions" style="display: none;">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span id="selected-bookmarks-count">0</span> 个收藏已选中
                    </div>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-danger"
                                data-bs-toggle="modal"
                                data-bs-target="#removeBookmarksModal">
                            <i class="bi bi-bookmark-x"></i> 批量取消收藏
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="clearBookmarkSelection()">
                            <i class="bi bi-x-circle"></i> 取消选择
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 空状态 -->
        {% else %}
        <div class="card shadow-sm text-center py-5">
            <div class="card-body">
                <i class="bi bi-bookmark display-1 text-muted"></i>
                <h3 class="mt-3">收藏夹空空如也</h3>
                <p class="text-muted mb-4">您还没有收藏任何文章</p>
                <a href="{% url 'blog:home' %}" class="btn btn-primary btn-lg">
                    <i class="bi bi-search"></i> 去发现好文章
                </a>
            </div>
        </div>
        {% endif %}

        <!-- 分页 -->
        {% if is_paginated %}
        <nav aria-label="收藏分页" class="mt-4">
            <ul class="pagination justify-content-center">
                {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page=1" aria-label="首页">
                        <span aria-hidden="true">&laquo;&laquo;</span>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}" aria-label="上一页">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
                {% endif %}

                {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                    <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                    <li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
                    {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}" aria-label="下一页">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}" aria-label="末页">
                        <span aria-hidden="true">&raquo;&raquo;</span>
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
</div>

<!-- 批量取消收藏确认模态框 -->
<div class="modal fade" id="removeBookmarksModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">确认批量取消收藏</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>确定要取消选中的 <span id="remove-count">0</span> 个收藏吗？</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" onclick="removeSelectedBookmarks()">确认取消</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.bookmark-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.bookmark-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.15) !important;
}

.bookmark-card .card-img-top {
    border-top-left-radius: calc(0.375rem - 1px);
    border-top-right-radius: calc(0.375rem - 1px);
}

.bookmark-checkbox:checked ~ .bookmark-card {
    background-color: rgba(13, 110, 253, 0.1);
    border-color: #0d6efd;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let selectedBookmarks = new Set();

// 切换批量选择模式
document.getElementById('toggle-bookmark-selection')?.addEventListener('click', function() {
    const checkboxes = document.querySelectorAll('.bookmark-checkbox');
    const bulkActions = document.getElementById('bulk-bookmark-actions');
    const showCheckboxes = checkboxes[0].style.display === 'none';

    checkboxes.forEach(cb => {
        cb.style.display = showCheckboxes ? 'block' : 'none';
        const card = cb.closest('.bookmark-card');
        if (card) {
            card.style.border = showCheckboxes ? '2px solid #0d6efd' : '';
        }
    });

    bulkActions.style.display = showCheckboxes ? 'block' : 'none';

    if (!showCheckboxes) {
        clearBookmarkSelection();
    }
});

// 更新选择状态
function updateBookmarkSelection(checkbox) {
    const bookmarkId = checkbox.dataset.bookmarkId;
    const card = checkbox.closest('.bookmark-card');

    if (checkbox.checked) {
        selectedBookmarks.add(bookmarkId);
        if (card) {
            card.style.border = '2px solid #0d6efd';
            card.style.backgroundColor = 'rgba(13, 110, 253, 0.1)';
        }
    } else {
        selectedBookmarks.delete(bookmarkId);
        if (card) {
            card.style.border = '';
            card.style.backgroundColor = '';
        }
    }
}

// 更新选中计数
function updateBookmarkSelectedCount() {
    const count = selectedBookmarks.size;
    document.getElementById('selected-bookmarks-count').textContent = count;
    document.getElementById('remove-count').textContent = count;
}

// 清除选择
function clearBookmarkSelection() {
    selectedBookmarks.clear();
    document.querySelectorAll('.bookmark-checkbox').forEach(cb => {
        cb.checked = false;
        const card = cb.closest('.bookmark-card');
        if (card) {
            card.style.border = '';
            card.style.backgroundColor = '';
        }
    });
    updateBookmarkSelectedCount();
}

// 取消收藏单篇文章
function removeBookmark(bookmarkId) {
    if (confirm('确定要取消收藏这篇文章吗？')) {
        fetch(`/blog/article/${bookmarkId}/bookmark/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('已取消收藏');
                location.reload();
            } else {
                alert('操作失败：' + data.error);
            }
        })
        .catch(error => console.error('Error:', error));
    }
}

// 批量取消收藏
function removeSelectedBookmarks() {
    if (selectedBookmarks.size === 0) {
        alert('请先选择要取消收藏的文章');
        return;
    }

    if (confirm(`确定要取消收藏 ${selectedBookmarks.size} 篇文章吗？`)) {
        fetch('/blog/bookmarks/remove-multiple/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ bookmark_ids: Array.from(selectedBookmarks) })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`成功取消收藏 ${data.removed_count} 篇文章`);
                location.reload();
            } else {
                alert('操作失败：' + data.error);
            }
        })
        .catch(error => console.error('Error:', error));
    }
}

// 分享文章
function shareArticle(title, url) {
    const shareText = `推荐一篇文章：《${title}》 ${url}`;

    if (navigator.share) {
        navigator.share({
            title: title,
            text: '推荐这篇文章给你',
            url: url
        });
    } else if (navigator.clipboard) {
        navigator.clipboard.writeText(shareText).then(() => {
            alert('文章链接已复制到剪贴板');
        });
    } else {
        prompt('请复制以下链接分享：', shareText);
    }
}

// 卡片悬停效果
document.querySelectorAll('.bookmark-card').forEach(card => {
    card.addEventListener('mouseenter', function() {
        if (!this.style.border || this.style.border === 'none') {
            this.style.boxShadow = '0 8px 16px rgba(0,0,0,0.1)';
        }
    });

    card.addEventListener('mouseleave', function() {
        if (!this.style.border || this.style.border === 'none') {
            this.style.boxShadow = '';
        }
    });
});

// 初始化事件监听
document.addEventListener('DOMContentLoaded', function() {
    // 复选框变化事件
    document.querySelectorAll('.bookmark-checkbox').forEach(cb => {
        cb.addEventListener('change', function() {
            updateBookmarkSelection(this);
            updateBookmarkSelectedCount();
        });
    });

    // 批量操作模态框更新
    document.getElementById('removeBookmarksModal').addEventListener('show.bs.modal', function() {
        document.getElementById('remove-count').textContent = selectedBookmarks.size;
    });
});
</script>
{% endblock %}